<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Adjudicator AI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --bg-dark: #111827; --bg-surface: #1F2937; --primary: #38BDF8; --primary-dark: #0E7490;
            --text-light: #F9FAFB; --text-medium: #9CA3AF; --border-color: #374151;
            --approved-bg: rgba(74, 222, 128, 0.1); --approved-border: #4ADE80;
            --rejected-bg: rgba(248, 113, 113, 0.1); --rejected-border: #F87171;
            --font-main: 'Inter', sans-serif;
        }
        html { font-size: 100%; }
        body { font-family: var(--font-main); background-color: var(--bg-dark); margin: 0; display: grid; place-items: center; height: 100vh; color: var(--text-light); overflow: hidden; }
        .chat-container { width: 95%; max-width: 800px; height: 95vh; background: var(--bg-surface); border-radius: 1.5rem; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; flex-direction: column; border: 1px solid var(--border-color); }
        
        .chat-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 1rem; }
        .chat-header h1 { font-size: 1.4rem; font-weight: 600; margin: 0; color: var(--text-light); }
        .controls { margin-left: auto; display: flex; align-items: center; gap: 0.75rem; }
        .controls select { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); font-size: 0.9rem; background-color: #374151; color: var(--text-light); cursor: pointer; }
        .icon-btn { background: var(--bg-surface); border: 1px solid var(--border-color); cursor: pointer; color: var(--text-medium); transition: all 0.2s; padding: 0.6rem; border-radius: 0.5rem; display: grid; place-items: center; }
        .icon-btn:hover { color: var(--primary); border-color: var(--primary); }
        .icon-btn svg { width: 22px; height: 22px; stroke-width: 2; }
        
        .chat-messages { flex-grow: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }
        .message { max-width: 85%; padding: 0.8rem 1.25rem; border-radius: 1.25rem; line-height: 1.6; animation: slide-up 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        @keyframes slide-up { 0% { transform: translateY(15px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .user { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-bottom-right-radius: 0.25rem; align-self: flex-end; }
        .bot { background: #374151; color: var(--text-light); border-bottom-left-radius: 0.25rem; align-self: flex-start; }
        .thinking { color: var(--text-medium); font-style: italic; }

        .decision-card { border-radius: 0.75rem; padding: 1.25rem; margin-top: 0.5rem; align-self: flex-start; width: 95%; max-width: 600px; animation: slide-up 0.4s forwards; }
        .decision-card.approved { background: var(--approved-bg); border: 1px solid var(--approved-border); }
        .decision-card.rejected { background: var(--rejected-bg); border: 1px solid var(--rejected-border); }
        .decision-title { font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; }
        .decision-card.approved .decision-title { color: var(--approved-border); }
        .decision-card.rejected .decision-title { color: var(--rejected-border); }
        .decision-amount { font-size: 1.1rem; font-weight: 600; color: var(--text-light); margin-bottom: 1rem; }
        .justification { margin: 1rem 0; line-height: 1.7; }
        .clauses-toggle { font-weight: 600; cursor: pointer; color: var(--primary); margin-bottom: 0.75rem; display: inline-block; }
        .clauses-content { display: none; border-left: 3px solid var(--primary); padding-left: 1rem; font-size: 0.9rem; color: var(--text-medium); }
        .clauses-content pre { white-space: pre-wrap; word-wrap: break-word; font-family: inherit; margin: 0; }
        
        .input-area { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); }
        .input-area form { display: flex; align-items: center; gap: 1rem; }
        #chatInput { flex-grow: 1; padding: 0.875rem 1.25rem; border-radius: 99px; border: 1px solid var(--border-color); font-size: 1rem; background-color: #111827; color: var(--text-light); }
        #chatInput:focus-visible { outline: 2px solid var(--primary); }
        #micBtn { background-color: var(--primary); border-radius: 50%; width: 50px; height: 50px; display: grid; place-items: center; color: white; transition: all 0.2s; border: none; }
        #micBtn.listening { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7); animation: pulse 1.5s infinite; }
        #micBtn.listening .mic-icon { display: none; }
        #micBtn:not(.listening) .stop-icon { display: none; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.4); } 70% { box-shadow: 0 0 0 12px rgba(56, 189, 248, 0); } 100% { box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); } }

        /* --- NEW: File Upload Modal --- */
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-backdrop.visible { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--bg-surface); padding: 2rem; border-radius: 1rem; border: 1px solid var(--border-color); width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-header h2 { margin: 0; font-size: 1.25rem; }
        #closeModalBtn { background: none; border: none; color: var(--text-medium); font-size: 1.5rem; cursor: pointer; }
        .upload-area { border: 2px dashed var(--border-color); border-radius: 0.75rem; padding: 2rem; text-align: center; transition: border-color 0.2s; }
        .upload-area.dragover { border-color: var(--primary); }
        .upload-area p { margin: 0 0 1rem 0; }
        #fileInput { display: none; }
        #uploadStatus { margin-top: 1rem; text-align: center; }
    </style>
</head>
<body>
    <div class="chat-container">
        <header class="chat-header">
            <h1>Policy Adjudicator AI</h1>
            <div class="controls">
                <select id="policySelect" aria-label="Select a policy document"></select>
                <button id="uploadBtn" class="icon-btn" title="Upload New Policy">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5-5 5 5M12 15V3"/></svg>
                </button>
            </div>
        </header>
        <main class="chat-messages" id="chatMessages"></main>
        <footer class="input-area">
            <form id="chatForm">
                <input type="text" id="chatInput" placeholder="Enter your claim or question..." autocomplete="off">
                <button type="button" id="micBtn" class="icon-btn" title="Start Voice Input">
                    <span class="mic-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3zM19 10v2a7 7 0 0 1-14 0v-2M12 19v4M8 23h8"/></svg></span>
                    <span class="stop-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12"></rect></svg></span>
                </button>
            </form>
        </footer>
    </div>

    <!-- NEW: Upload Modal HTML -->
    <div id="uploadModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Upload Policy Document</h2>
                <button id="closeModalBtn">&times;</button>
            </div>
            <div id="uploadArea" class="upload-area">
                <p>Drag & Drop your file here</p>
                <p>or</p>
                <button onclick="document.getElementById('fileInput').click()" class="icon-btn" style="padding: 0.8rem 1.5rem; border-radius: 99px;">Select File</button>
                <input type="file" id="fileInput" accept=".pdf,.docx,.txt">
            </div>
            <div id="uploadStatus"></div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const ui = {
            chatMessages: document.getElementById('chatMessages'), chatForm: document.getElementById('chatForm'),
            chatInput: document.getElementById('chatInput'), policySelect: document.getElementById('policySelect'),
            micBtn: document.getElementById('micBtn'), uploadBtn: document.getElementById('uploadBtn'),
            uploadModal: document.getElementById('uploadModal'), closeModalBtn: document.getElementById('closeModalBtn'),
            uploadArea: document.getElementById('uploadArea'), fileInput: document.getElementById('fileInput'),
            uploadStatus: document.getElementById('uploadStatus')
        };
        let conversationHistory = []; let isListening = false;

        // --- Core Application Logic (Chat, Speech, etc.) ---
        // This section remains largely the same as the previous version.
        // ... (addMessage, createDecisionCard, toggleListening, etc.) ...
        function addMessage(sender, content, type = 'text') {
            const messageContainer = document.createElement('div');
            if (type === 'decision' && sender === 'bot') {
                messageContainer.appendChild(createDecisionCard(content));
            } else {
                messageContainer.classList.add('message', sender);
                messageContainer.textContent = content;
                if (type === 'thinking') messageContainer.classList.add('thinking');
            }
            ui.chatMessages.appendChild(messageContainer);
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
            return messageContainer;
        }
        function createDecisionCard(data) {
            const card = document.createElement('div');
            const decision = data.decision || 'Info';
            const decisionClass = decision.toLowerCase().replace(/\s+/g, '-');
            card.className = `decision-card ${decisionClass === 'approved' ? 'approved' : 'rejected'}`;
            const titleText = `Claim ${decision}`;
            const amountHTML = (decision === 'Approved' && data.amount) ? `<h2 class="decision-amount">Approved Amount: ${data.amount}</h2>` : '';
            card.innerHTML = `<h1 class="decision-title">${titleText}</h1>${amountHTML}<p class="justification">${data.justification || 'No justification provided.'}</p>${data.cited_clauses && data.cited_clauses.length > 0 ? `<div class="clauses-toggle" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'block' ? 'none' : 'block';">Show Supporting Clauses ▼</div><div class="clauses-content"><pre>${data.cited_clauses.join('\n\n---\n\n')}</pre></div>` : ''}`;
            return card;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.continuous = false; recognition.lang = 'en-US';
            recognition.onresult = e => { ui.chatInput.value = e.results[0][0].transcript; };
            recognition.onend = () => { if (ui.chatInput.value.trim()) ui.chatForm.requestSubmit(); toggleListening(false); };
        }
        const toggleListening = (start) => {
            isListening = start;
            ui.micBtn.classList.toggle('listening', start);
            ui.micBtn.title = start ? 'Stop Listening' : 'Start Voice Input';
            if (!recognition) return;
            try { start ? recognition.start() : recognition.stop(); } catch(e) { console.error("Speech Recognition Error:", e); }
        };
        ui.micBtn.addEventListener('click', () => toggleListening(!isListening));
        ui.chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userQuery = ui.chatInput.value.trim();
            if (!userQuery) return;
            const selectedPolicy = ui.policySelect.value;
            if (!selectedPolicy) { addMessage('bot', "Please upload and select a policy document first.", 'decision'); return; }
            addMessage('user', userQuery);
            ui.chatInput.value = '';
            conversationHistory.push({ role: 'user', content: userQuery });
            const thinkingIndicator = addMessage('bot', 'Analyzing policy...', 'thinking');
            try {
                const res = await fetch('/chat', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: userQuery, policy: selectedPolicy, history: conversationHistory }),
                });
                thinkingIndicator.remove();
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'An unknown error occurred.');
                addMessage('bot', data, 'decision');
                conversationHistory.push({ role: 'assistant', content: JSON.stringify(data) });
            } catch (err) {
                if(thinkingIndicator) thinkingIndicator.remove();
                addMessage('bot', { decision: 'Error', justification: err.message }, 'decision');
            }
        });

        // --- NEW: File Upload Logic ---
        function showUploadModal(show) {
            ui.uploadModal.classList.toggle('visible', show);
            if (!show) {
                ui.uploadStatus.innerHTML = '';
                ui.fileInput.value = ''; // Reset file input
            }
        }

        async function handleFileUpload(file) {
            if (!file) return;
            const formData = new FormData();
            formData.append('policyFile', file);

            ui.uploadStatus.innerHTML = `Uploading <b>${file.name}</b>...`;
            
            try {
                const res = await fetch('/upload_policy', {
                    method: 'POST',
                    body: formData,
                });
                const result = await res.json();
                if (!res.ok) throw new Error(result.error);
                
                ui.uploadStatus.innerHTML = `<span style="color: var(--approved-border);">${result.message}</span>`;
                await loadPolicies(); // Refresh the dropdown
                ui.policySelect.value = result.filename; // Select the new file
                
                setTimeout(() => showUploadModal(false), 1500);

            } catch (error) {
                ui.uploadStatus.innerHTML = `<span style="color: var(--rejected-border);">Error: ${error.message}</span>`;
            }
        }

        ui.uploadBtn.addEventListener('click', () => showUploadModal(true));
        ui.closeModalBtn.addEventListener('click', () => showUploadModal(false));
        ui.uploadModal.addEventListener('click', (e) => {
            if (e.target === ui.uploadModal) showUploadModal(false);
        });

        // Drag and Drop Events
        ui.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            ui.uploadArea.classList.add('dragover');
        });
        ui.uploadArea.addEventListener('dragleave', () => {
            ui.uploadArea.classList.remove('dragover');
        });
        ui.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            ui.uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            handleFileUpload(file);
        });
        ui.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            handleFileUpload(file);
        });

        // --- Initialization ---
        const loadPolicies = async () => {
            try {
                const res = await fetch('/list_policies');
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                ui.policySelect.innerHTML = data.policies.length ?
                    data.policies.map(p => `<option value="${p}">${p}</option>`).join('') :
                    '<option value="">Upload a document</option>';
            } catch (error) {
                ui.policySelect.innerHTML = `<option value="">Error: ${error.message}</option>`;
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            loadPolicies();
            addMessage('bot', 'Hello! I am your Policy Adjudicator AI. Please select a document or upload a new one to get started.');
        });
    </script>
</body>
</html>