<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Policy Assistant</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');
        :root {
            --primary: #5A54F9; --primary-light: #F0F0FF; --text-dark: #212121;
            --text-light: #616161; --bg-light: #F5F5F5; --bg-white: #FFFFFF;
            --border: #E0E0E0; --font: 'Roboto', sans-serif;
        }
        html { font-size: 100%; }
        body { font-family: var(--font); background-color: var(--bg-light); margin: 0; display: grid; place-items: center; height: 100vh; }
        .chat-container { width: 95%; max-width: 800px; height: 95vh; background: var(--bg-white); border-radius: 1rem; box-shadow: 0 8px 32px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        .chat-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 1rem; }
        .chat-header h1 { font-size: 1.5rem; margin: 0; color: var(--text-dark); }
        .controls { margin-left: auto; display: flex; align-items: center; gap: 0.5rem; }
        .controls select { padding: 0.5rem 1rem; border-radius: 99px; border: 1px solid var(--border); font-size: 0.9rem; background-color: var(--bg-light); }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 1.75rem; color: var(--text-light); padding: 0.5rem; border-radius: 50%; transition: all 0.2s; }
        .icon-btn:hover { color: var(--primary); background-color: var(--primary-light); }

        .chat-messages { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; }
        .message { max-width: 80%; padding: 0.75rem 1.25rem; border-radius: 1.25rem; line-height: 1.6; animation: pop-in 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes pop-in { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .user { background-color: var(--primary); color: white; border-bottom-right-radius: 0.25rem; align-self: flex-end; }
        .bot { background-color: var(--primary-light); color: var(--text-dark); border: 1px solid #E0E0FF; border-bottom-left-radius: 0.25rem; align-self: flex-start; }
        .error { background-color: #FFEBEE; color: #C62828; }

        .input-area { padding: 1rem; border-top: 1px solid var(--border); }
        .input-area form { display: flex; align-items: center; gap: 1rem; }
        #chatInput { flex-grow: 1; padding: 0.875rem 1.25rem; border-radius: 99px; border: 1px solid var(--border); font-size: 1rem; }
        #chatInput:focus-visible { outline: 2px solid var(--primary); }
        #micBtn.listening .mic-icon { display: none; }
        #micBtn:not(.listening) .stop-icon { display: none; }
        .pulse { animation: pulse-animation 1.5s infinite; }
        @keyframes pulse-animation { 0% { box-shadow: 0 0 0 0 rgba(90, 84, 249, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(90, 84, 249, 0); } 100% { box-shadow: 0 0 0 0 rgba(90, 84, 249, 0); } }

        /* Modal Styles are omitted for brevity, they can be reused from previous versions */
    </style>
</head>
<body>
    <div class="chat-container">
        <header class="chat-header">
            <h1>Policy Pal</h1>
            <div class="controls">
                <select id="policySelect" aria-label="Select a policy document"></select>
                <button id="uploadBtn" class="icon-btn" title="Upload Document">üì§</button>
            </div>
        </header>
        <main class="chat-messages" id="chatMessages"></main>
        <footer class="input-area">
            <form id="chatForm">
                <input type="text" id="chatInput" placeholder="Ask about your policy..." autocomplete="off">
                <button type="button" id="micBtn" class="icon-btn" title="Start Voice Input">
                    <span class="mic-icon">üé§</span>
                    <span class="stop-icon">‚èπÔ∏è</span>
                </button>
            </form>
        </footer>
    </div>

    <script>
        // --- DOM Elements & State ---
        const ui = { chatMessages: document.getElementById('chatMessages'), chatForm: document.getElementById('chatForm'), chatInput: document.getElementById('chatInput'), policySelect: document.getElementById('policySelect'), micBtn: document.getElementById('micBtn'), uploadBtn: document.getElementById('uploadBtn') };
        let conversationHistory = [];
        let isListening = false;
        
        // --- HAPTIC FEEDBACK ---
        const haptic = () => navigator.vibrate && navigator.vibrate(50);
        
        // --- SPEECH RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        if (recognition) {
            recognition.continuous = false; recognition.lang = 'en-IN';
            recognition.onresult = e => ui.chatInput.value = e.results[0][0].transcript;
            recognition.onend = () => { if (ui.chatInput.value) ui.chatForm.requestSubmit(); toggleListening(false); };
        }
        const toggleListening = (start) => {
            isListening = start;
            ui.micBtn.classList.toggle('listening', start);
            ui.micBtn.classList.toggle('pulse', start);
            ui.micBtn.title = start ? 'Stop Listening' : 'Start Voice Input';
            if (!recognition) return;
            start ? recognition.start() : recognition.stop();
        };

        // --- UI & MESSAGE HANDLING ---
        const addMessage = (sender, text) => {
            const el = document.createElement('div');
            el.classList.add('message', sender);
            el.textContent = text;
            ui.chatMessages.appendChild(el);
            ui.chatMessages.scrollTop = ui.chatMessages.scrollHeight;
            return el;
        };

        const handleBotResponse = (data) => {
            if (data.answer) {
                addMessage('bot', data.answer);
                conversationHistory.push({ role: 'assistant', content: data.answer });
            }
            // Ask the follow-up question after a short, natural delay
            if (data.follow_up_question) {
                setTimeout(() => {
                    addMessage('bot', data.follow_up_question);
                    conversationHistory.push({ role: 'assistant', content: data.follow_up_question });
                }, 1000);
            }
        };
        
        // --- EVENT LISTENERS ---
        ui.chatForm.addEventListener('submit', async (e) => {
            e.preventDefault(); haptic();
            const userQuery = ui.chatInput.value.trim();
            if (!userQuery) return;
            const selectedPolicy = ui.policySelect.value;
            if (!selectedPolicy) { addMessage("error", "Please upload and select a policy document first."); return; }

            addMessage('user', userQuery);
            ui.chatInput.value = '';
            conversationHistory.push({ role: 'user', content: userQuery });

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: userQuery, policy: selectedPolicy, history: conversationHistory }),
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error);
                handleBotResponse(data);
            } catch (err) { addMessage('error', `Error: ${err.message}`); }
        });
        
        ui.micBtn.addEventListener('click', () => { haptic(); toggleListening(!isListening); });
        
        // --- INITIALIZATION ---
        const loadPolicies = async () => {
            const res = await fetch('/list_policies');
            const data = await res.json();
            ui.policySelect.innerHTML = data.policies.length ? 
                data.policies.map(p => `<option value="${p}">${p}</option>`).join('') :
                '<option value="">Upload a document</option>';
        };
        
        // Modal and upload logic can be added here, similar to previous versions
        // ui.uploadBtn.onclick = ...

        window.addEventListener('DOMContentLoaded', () => {
            loadPolicies();
            addMessage('bot', 'Hello! I am your Policy Pal. Please select a document from the dropdown above to get started.');
        });
    </script>
</body>
</html>